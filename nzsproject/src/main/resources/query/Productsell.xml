<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.needmall.seller.productsell.dao.ProductsellDao">
  	
  	<!-- 판매상품 목록 조회-->
	<select id="productList" parameterType="String" resultType="productselllist">
		SELECT ps_num, pi_image, p_name, p_price, TO_CHAR(ps_expiration ,'yyyy/mm/dd hh24:mi') AS ps_expiration, ps_count, ps_price, ps_udate
		FROM seller s INNER JOIN store st ON s.s_num = st.s_num INNER JOIN productsell ps ON ps.s_num = s.s_num INNER JOIN product p ON p.p_num = ps.p_num INNER JOIN proimage pi ON pi.pi_num = p.pi_num
		WHERE s_id = #{s_id} AND ps_state = 0 ORDER BY ps_expiration
	</select>
	
	<!-- 등록상품 정보 조회 -->
	<select id="searchList" parameterType="usercommon" resultType="productinfo">
		SELECT p_num, pi_image, p_name, p_price, p_content
		FROM product p INNER JOIN proimage pi ON pi.pi_num = p.pi_num
		WHERE p_state = 0 AND p_name LIKE '%' || #{keyword} || '%' AND (p_division = (SELECT si_division FROM seller s INNER JOIN store st ON s.s_num = st.s_num WHERE s_id = #{s_id}) OR p_division = '공통')
	</select>
	
	<!-- 판매상품 등록 -->
	<insert id="productInsert" parameterType="productinsert">
		<selectKey keyProperty="ps_num" resultType="int" order="BEFORE">
			SELECT productsell_seq.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO productsell (ps_num, p_num, ps_expiration, ps_count, ps_price, s_num, ps_state )
		VALUES (#{ps_num}, #{p_num}, TO_DATE(#{ps_expiration},'yyyy/mm/dd hh24:mi'), #{ps_count}, #{ps_price}, (SELECT s.s_num FROM seller s INNER JOIN store st ON s.s_num = st.s_num WHERE s_id = #{s_id}), 0)
	</insert>
	
	<!-- 상세 페이지 조회 -->
	<select id="productDetail" parameterType="productinsert" resultType="productlistone">
		SELECT ps.p_num, ps_num, pi_image, p_name, p_price, p_content, TO_CHAR(ps_expiration ,'yyyy/mm/dd hh24:mi') AS ps_expiration, ps_count, ps_price, ps_regdate
		FROM seller s INNER JOIN store st ON s.s_num = st.s_num INNER JOIN productsell ps ON ps.s_num = s.s_num INNER JOIN product p ON p.p_num = ps.p_num INNER JOIN proimage pi ON pi.pi_num = p.pi_num
		WHERE ps_num = #{ps_num} AND s_id = #{s_id} ORDER BY p_name
	</select>
	
	<!-- 상품 상태 변경 -->	
	<update id="productUpdate" parameterType="productinsert">
		UPDATE productsell
		SET ps_state = 1
		WHERE ps_num = #{ps_num} AND s_num = (SELECT s.s_num FROM seller s INNER JOIN store st ON s.s_num = st.s_num WHERE s_id = #{s_id}) AND ps_state = 0
	</update>
</mapper>