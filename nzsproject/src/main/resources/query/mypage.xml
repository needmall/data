<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.needmall.client.mypage.dao.MypageDao">
	<select id="mycartList" parameterType="mypage" resultType="mypage">
		SELECT
		    cart2dep.cart2_num,
		    cart2dep.cart1_num,
		    cart2dep.ps_num,
		    cart2dep.cart2_count,
		    cart1dep.cart1_num,
		    cart1dep.cart1_date,
		    cart1dep.c_num,
		    ps_regdate,
		    ps_expiration,
		    ps_count,
		    ps_price,
		    s_num,
		    ps_state,
		    ps_udate,
		    product.p_name,
		    product.p_price,
		    product.p_date,
		    product.p_udate,
		    product.p_content,
		    product.p_division,
		    pi_image
		
		FROM
		    cart2dep inner join cart1dep on cart2dep.cart1_num = cart1dep.cart1_num
		    inner join productsell on productsell.ps_num = cart2dep.ps_num
		    inner join product on product.p_num = productsell.p_num 
		    inner join proimage on proimage.pi_num = product.pi_num
		WHERE c_num =1
	</select>
	<update id="countUpdate" parameterType="mypage">
		UPDATE cart2dep SET cart2_count = #{cart2_count}
		WHERE cart2_num =#{cart2_num}
	</update>
	<delete id="itemDelete" parameterType="mypage">
		DELETE FROM cart2dep
		WHERE cart2_num=#{cart2_num}
	</delete>
	
	<select id="buyList" parameterType="mypage" resultType="mypage">
		
        SELECT
		    buy1dep.b1_num,
		    b1_date,
		    c_num,
		    b2_num,
		    buy2dep.ps_num,
		    b_count,
		    b_confirm,
		    productsell.p_num,
		    ps_regdate,
		    ps_expiration,
		    ps_count,
		    ps_price,
		    s_num,
		    ps_state,
		    ps_udate,
		    c2_num,
		    p_name,
		    p_price,
		    p_date,
		    p_udate,
		    p_content,
		    p_division,
		    proimage.pi_num,
		    p_state,
		    pi_image
		    
		FROM
		    buy1dep inner join buy2dep on buy1dep.b1_num = buy2dep.b1_num
		    inner join productsell on productsell.ps_num = buy2dep.ps_num
		    inner join product on product.p_num = productsell.p_num
		    inner join proimage on proimage.pi_num =product.pi_num

		WHERE
		     buy1dep.c_num = 1
		     
    
	</select>
	<select id="mycartConfirm" parameterType="mypage" resultType="int">
		select count(*) from BUY1DEP where c_num = #{c_num} and to_char(b1_date,'yyyy-mm-dd') = to_char(sysdate,'yyyy-mm-dd')
	</select>
		
	<insert id="mycartBuy1deptInsert" parameterType="mypage">
		INSERT INTO buy1dep (b1_num,c_num) VALUES (buy1dep_seq.nextval,#{c_num})
	</insert>
	      
	<insert id="mycartBuy2deptInsert" parameterType="mypage">
		  <selectKey keyProperty="b1_num" resultType ="int" order="BEFORE">
			SELECT b1_num FROM buy1dep where c_num = #{c_num} and to_char(b1_date,'yyyy-mm-dd') = to_char(sysdate,'yyyy-mm-dd')
		  </selectKey>
		  
		  INSERT INTO buy2dep (b2_num,b1_num,ps_num,b_count,b_confirm)
	      VALUES (BUY2DEP_SEQ.NEXTVAL,#{b1_num},#{ps_num},#{ps_num},0)
	</insert>
	
	<update id="dateCountUpdate" parameterType="mypage">
	    UPDATE cart1dep
		SET
		    cart1_date = sysdate
		WHERE
		    c_num = #{c_num}
	</update>
	
	<update id="psCountUpdate">

		UPDATE productsell
		SET
		    ps_count = #{changeCount}
		WHERE
		    ps_num = #{ps_num}
	</update>
	<select id="cartConfirmList" parameterType="mypage" resultType="int">
	 	SELECT COUNT(*) FROM
	   	 	cart2dep inner join 
	    	cart1dep on cart2dep.cart1_num = cart1dep.cart1_num
	    where c_num = #{c_num} and ps_num = #{ps_num}
	</select>
</mapper>